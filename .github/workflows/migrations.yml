name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      direction:
        description: "Migration direction"
        required: true
        default: "up"
        type: choice
        options:
          - up
          - down

permissions:
  id-token: write
  contents: read

jobs:
  migrate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-terraform
          aws-region: eu-west-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push migrations image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: blc-migrations
          IMAGE_TAG: latest
        run: |
          docker build -f backend/Dockerfile.migrations \
            -t "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}" backend
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

      - name: Run migrations task
        env:
          MIGRATION_DIRECTION: ${{ inputs.direction }}
          ECS_CLUSTER: ${{ vars.MIGRATIONS_CLUSTER || 'blc-migrations' }}
          ECS_TASK_DEFINITION: ${{ vars.MIGRATIONS_TASK_DEFINITION || 'blc-migrations' }}
          ECS_SECURITY_GROUP_ID: ${{ vars.MIGRATIONS_SG_ID }}
          ECS_SUBNET_IDS: ${{ vars.MIGRATIONS_SUBNET_IDS }}
        run: |
          set -euo pipefail
          LOG_GROUP="/ecs/blc-migrations"
          MAX_WAIT_SECONDS=300
          SLEEP_SECONDS=10
          if [ -z "${ECS_SUBNET_IDS}" ] || [ "${ECS_SUBNET_IDS}" = "null" ]; then
            echo "Missing ECS subnet IDs."
            exit 1
          fi
          if [ -z "${ECS_SECURITY_GROUP_ID}" ] || [ "${ECS_SECURITY_GROUP_ID}" = "null" ]; then
            echo "Missing ECS security group ID."
            exit 1
          fi
          subnet_ids_csv=$(echo "${ECS_SUBNET_IDS}" | jq -r 'join(",")')
          if [ -z "${subnet_ids_csv}" ] || [ "${subnet_ids_csv}" = "null" ]; then
            echo "ECS subnet IDs could not be parsed."
            exit 1
          fi
          if [ -z "${MIGRATION_DIRECTION}" ]; then
            echo "Missing migration direction."
            exit 1
          fi
          network_config="awsvpcConfiguration={subnets=[${subnet_ids_csv}],securityGroups=[${ECS_SECURITY_GROUP_ID}],assignPublicIp=ENABLED}"
          echo "Using network configuration: ${network_config}"
          overrides="containerOverrides=[{name=migrations,command=[${MIGRATION_DIRECTION}]}]"
          echo "Using overrides: ${overrides}"

          task_arn=$(aws ecs run-task \
            --cluster "${ECS_CLUSTER}" \
            --task-definition "${ECS_TASK_DEFINITION}" \
            --launch-type FARGATE \
            --network-configuration "${network_config}" \
            --overrides "${overrides}" \
            --query 'tasks[0].taskArn' \
            --output text)

          if [ -z "${task_arn}" ] || [ "${task_arn}" = "None" ]; then
            echo "Failed to start migration task."
            exit 1
          fi

          task_id="${task_arn##*/}"
          log_stream="ecs/migrations/${task_id}"

          echo "Task ARN: ${task_arn}"
          echo "Expected log stream: ${log_stream}"

          next_token=""
          elapsed=0
          while [ "${elapsed}" -lt "${MAX_WAIT_SECONDS}" ]; do
            status=$(aws ecs describe-tasks \
              --cluster "${ECS_CLUSTER}" \
              --tasks "${task_arn}" \
              --query 'tasks[0].lastStatus' \
              --output text || true)

            if [ -n "${status}" ] && [ "${status}" != "None" ]; then
              echo "Task status: ${status}"
            fi

            if [ -n "${next_token}" ]; then
              logs_response=$(aws logs get-log-events \
                --log-group-name "${LOG_GROUP}" \
                --log-stream-name "${log_stream}" \
                --next-token "${next_token}" \
                --limit 50 \
                --query '{events:events,nextForwardToken:nextForwardToken}' \
                --output json 2>/dev/null || true)
            else
              logs_response=$(aws logs get-log-events \
                --log-group-name "${LOG_GROUP}" \
                --log-stream-name "${log_stream}" \
                --start-from-head \
                --limit 50 \
                --query '{events:events,nextForwardToken:nextForwardToken}' \
                --output json 2>/dev/null || true)
            fi

            if [ -n "${logs_response}" ]; then
              echo "${logs_response}" | jq -r '.events[].message' || true
              next_token=$(echo "${logs_response}" | jq -r '.nextForwardToken' || echo "")
            fi

            if [ "${status}" = "STOPPED" ]; then
              break
            fi

            sleep "${SLEEP_SECONDS}"
            elapsed=$((elapsed + SLEEP_SECONDS))
          done

          if [ "${elapsed}" -ge "${MAX_WAIT_SECONDS}" ]; then
            echo "Timed out waiting for task to stop. Check ECS logs and task details: ${task_arn}"
            exit 1
          fi

          exit_code=$(aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks "${task_arn}" \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)
          reason=$(aws ecs describe-tasks \
            --cluster "${ECS_CLUSTER}" \
            --tasks "${task_arn}" \
            --query 'tasks[0].stoppedReason' \
            --output text)

          echo "Migration task exit code: ${exit_code}"
          echo "Migration task stopped reason: ${reason}"

          if [ "${exit_code}" != "0" ]; then
            exit 1
          fi
